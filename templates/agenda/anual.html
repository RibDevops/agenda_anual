{% extends 'base.html' %}
{% load agenda_filters %}

{% block content %}
<div class="calendario-header">
    CALEND√ÅRIO ANUAL DE ATIVIDADES - {{ ano }}
</div>

<div class="calendario-wrapper">
    <div class="calendario-anual">
    {% for mes_nome, semanas in calendario.items %}
    <div class="mes-container">
        <div class="mes-nome">{{ mes_nome|upper }}</div>

        <table class="agenda">
            <thead>
                <tr>
                    <th>S</th><th>T</th><th>Q</th><th>Q</th><th>S</th><th>S</th><th>D</th>
                </tr>
            </thead>
            <tbody>
                {% for semana in semanas %}
                <tr>
                    {% for dia in semana %}
                    {% with eventos=eventos_por_data|get_item:dia %}
                    <td class="{% if dia.month_name != mes_nome %}fora-mes{% endif %} {% if eventos %}{% for ev in eventos %}bg-{{ ev.cor }} {% endfor %}{% endif %}">
                        <span class="dia-numero">{{ dia.day }}</span>
                    </td>
                    {% endwith %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
    </div>
</div>

<div class="secoes-container">
    <div class="secao-box">
        <div class="secao-titulo">LEGENDA</div>
        <div class="legenda-item"><div class="cor-box bg-red"></div> FERIADO</div>
        <div class="legenda-item"><div class="cor-box bg-blue"></div> ALTCOM</div>
    </div>
    <div class="secao-box">
        <div class="secao-titulo">PROJETO ATIVI</div>
    </div>
    <div class="secao-box">
        <div class="secao-titulo">G</div>
    </div>
    <div class="secao-box">
        <div class="secao-titulo">FORMATURAS</div>
        {% for e in todos_eventos %}
            {% if e.cor == 'pink' %}
                <div class="legenda-item" style="color: #c00000; font-weight: bold;">
                    {{ e.data|date:"d/m" }} - {{ e.titulo|upper }}
                </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div class="mt-4 text-center no-print">
  <button id="btn-png" class="btn btn-secondary">Exportar PNG</button>
  <a href="{% url 'agenda:gerar_pdf' %}?ano={{ ano }}" class="btn btn-primary">Gerar PDF</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
document.getElementById('btn-png').addEventListener('click', function(){
  html2canvas(document.querySelector('.calendario-wrapper'), {scale: 2}).then(function(canvas) {
    var link = document.createElement('a');
    link.download = 'calendario_{{ ano }}.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
});
</script>
{% endblock %}
